<!DOCTYPE html>
<html>
<head>
	<title>Wikipedia articles in Rogaland</title>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<!--<meta property="og:image" content="route.png" />-->
	<link rel="stylesheet" href="./lib/leaflet/leaflet.css" />
	<link rel="stylesheet" href="./lib/sidebar/L.Control.Sidebar.css" />
	<style>
		html, body, #map { margin: 0; height: 100%; background: #fff; }
		.leaflet-sidebar img { float: right; padding: 0 0 10px 10px; }
		#searchButton {top: 10px; right:10px; background-color: rgba(0, 0, 0, 0.5); position: absolute; padding: 10px; color: #ffffff}
	</style>
</head>
<body>

    <div id="sidebar"></div>
	<div id="map"></div>
	<div id="searchButton">SEARCH</div>
	<script src="./lib/reqwest.min.js"></script>
	<script src="./lib/leaflet/leaflet.js"></script>
	<script src="./lib/sidebar/L.Control.Sidebar.js"></script>
	<script src="./src/Leaflet.Wikipedia.js"></script>
	<script>

		var orale = null;

	var map = L.map('map', {
		minZoom: 5,
		maxZoom: 16,

	}).setView([40.3149907, -96.7695338], 5);

	var sidebar = L.control.sidebar('sidebar', {
		closeButton: true,
		position: 'right'
	});
	map.addControl(sidebar);

		document.getElementById("searchButton").addEventListener("click", updateWikis);
		
	L.tileLayer('http://{s}.tiles.mapbox.com/v3/spatialdev.map-4o51gab2/{z}/{x}/{y}.png', {
		detectRetina: true
	}).addTo(map);

	var template = '<h2>{label}</h2><p><img src="{thumbnail}">{abstract}</p><p><a target="_blank" href="{link}">Read on Wikipedia</a></p>';

	function getWikis(){
//		L.wikipedia({
//			query: {
//				fields: ['label', 'lat', 'lng', 'abstract', 'link', 'thumbnail'],
//				bounds: map.getBounds()
//			},
//			marker: {
////				icon: L.icon({ // Icons from http://www.icondrawer.com/social-icons.php
////					iconUrl: 'img/wikipedia_16.png',
////					iconRetinaUrl: 'img/wikipedia_32.png',
////					iconSize: [16, 16]
////				})
//				marker: L.circle([51.508, -0.11], 500, {
//					color: 'red',
//					fillColor: '#f03',
//					fillOpacity: 0.5
//				})
//
//			}
//		}).addTo(map).on('click', function(evt) {
//			sidebar.setContent(L.Util.template(template, evt.layer.data)).show();
//		});
		orale = new L.wikipedia({
			query: {
				fields: ['label', 'lat', 'lng', 'abstract', 'link', 'thumbnail'],
				bounds: map.getBounds()
			},
			marker: {
				icon: L.icon({ // Icons from http://www.icondrawer.com/social-icons.php
					iconUrl: 'img/wikipedia_16.png',
					iconRetinaUrl: 'img/wikipedia_32.png',
					iconSize: [22, 22]
				})
//				marker: L.circle([51.508, -0.11], 500, {
//					color: 'red',
//					fillColor: '#f03',
//					fillOpacity: 0.5
//				})

			}
		})
//		orale.addTo(map);
		map.addLayer(orale);
		orale.on('click', function(evt) {
			sidebar.setContent(L.Util.template(template, evt.layer.data)).show();
		});
	}

		function updateWikis(){
			orale.clearLayers();
			getWikis();
		}

//	var marker = null;
//	marker = L.marker(map.getCenter()).addTo(map);
	map.on('dragend', function() {
//		map.removeLayer(marker);
	});

	var options = {
		enableHighAccuracy: true,
		timeout: 5000,
		maximumAge: 0
	};

	function success(pos) {
		var crd = pos.coords;

		console.log('Your current position is:');
		console.log('Latitude : ' + crd.latitude);
		console.log('Longitude: ' + crd.longitude);
		console.log('More or less ' + crd.accuracy + ' meters.');

		map.setView([crd.latitude, crd.longitude], 14, {animation: true});
//		marker = L.marker(map.getCenter()).addTo(map);
		var circle = L.circle([crd.latitude, crd.longitude], 40, {
			color: 'red',
			fillColor: '#f03',
			fillOpacity: 0.5
		}).addTo(map);
		getWikis();

	};

	function error(err) {
		console.warn('ERROR(' + err.code + '): ' + err.message);
	};

	navigator.geolocation.getCurrentPosition(success, error, options);

	</script>
</body>
</html>